---
title: "NASH presence"
#author: "Luigui Gallardo Becerra, Adrián Ochoa Leyva"
date: "05.05.2023"
output:
  pdf_document: default
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Libraries required
library("colorRamps")
library("ggplot2")
library("reshape")
library("scales")
library("jcolors")
library("grid")
library("RColorBrewer")
library("dplyr")
library("ggpubr")
library("phyloseq")
library("microbiome")
library("vegan")
library("metagMisc")
library("DiagrammeR")
library("microbiomeMarker")
```

```{r, echo=FALSE}
metadata <- read.delim("./00_files/metadata_nash_presence.tsv")

knitr::kable(
  metadata
)
```

\newpage

## MetaPhlAn3, taxonomía

### Con todas las muestras comparando "NASH" vs "non-NASH"

<!-- #### Barplots -->

```{r, echo=FALSE, warning=FALSE, include=FALSE}
# Input table
biom_file <- "./00_files/metaphlan3_taxonomic_profile_filt.biom"

map_file <- "./00_files/metadata_nash_presence.tsv"

biom_otu_tax <- import_biom(biom_file)

metadata <- import_qiime_sample_data(map_file)

physeq <- merge_phyloseq(biom_otu_tax,
                         metadata)

physeq <- normalize(physeq,
                    method = "TSS")

colnames(tax_table(physeq)) <- c("Kingdom",
                                 "Phylum",
                                 "Class",
                                 "Order",
                                 "Family",
                                 "Genus",
                                 "Species")

theme_set(theme_bw())

# Phylum level
phylum <- aggregate_rare(physeq,
                         level = "Phylum",
                         detection = 0.0001,
                         prevalence = 50/100)

barplot_tax_phylum <- plot_bar(phylum,
                               fill = "Phylum") +
facet_grid(.~nash_presence,
           scales = "free_x") +
labs(x = "",
    y = "Relative abundance",
    fill = "Phylum") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_phylum_allsamples.svg")
print(barplot_tax_phylum)
dev.off()

# Class level
class <- aggregate_rare(physeq,
                         level = "Class",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_class <- plot_bar(class,
                               fill = "Class") +
facet_grid(.~nash_presence,
           scales = "free_x") +
labs(x = "",
    y = "Relative abundance",
    fill = "Class") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_class_allsamples.svg")
print(barplot_tax_class)
dev.off()

# Order level
order <- aggregate_rare(physeq,
                         level = "Order",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_order <- plot_bar(order,
                               fill = "Order") +
facet_grid(.~nash_presence,
           scales = "free_x") +
labs(x = "",
    y = "Relative abundance",
    fill = "Order") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_order_allsamples.svg")
print(barplot_tax_order)
dev.off()

# Family level
family <- aggregate_rare(physeq,
                         level = "Family",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_family <- plot_bar(family,
                               fill = "Family") +
facet_grid(.~nash_presence,
           scales = "free_x") +
labs(x = "",
    y = "Relative abundance",
    fill = "Family") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_family_allsamples.svg")
print(barplot_tax_family)
dev.off()

# Genera level
genera <- aggregate_rare(physeq,
                         level = "Genus",
                         detection = 0,
                         prevalence = 0)

genera.df <- phyloseq_to_df(genera,
                            addtax = FALSE,
                            addtot = FALSE,
                            addmaxrank = FALSE,
                            sorting = "NULL")
               
write.table(genera.df,
            "./00_files/genera_taxonomic_profile_allsamples.tsv",
            sep = "\t")

genera <- aggregate_rare(physeq,
                         level = "Genus",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_genera <- plot_bar(genera,
                               fill = "Genus") +
facet_grid(.~nash_presence,
           scales = "free_x") +
labs(x = "",
    y = "Relative abundance",
    fill = "Genus") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_genera_allsamples.svg")
print(barplot_tax_genera)
dev.off()

# Species level
species <- aggregate_rare(physeq,
                         level = "Species",
                         detection = 0,
                         prevalence = 0)

##### Prevotella copri boxplot
# 
# p_value <- p_value <- list(c("Control",
#                              "NASH"))
# 
# boxplot_prevotella_copri <- boxplot_abundance(species,
#                                               x="nash_presence",
#                                               y="Prevotella_copri",
#                                               show.points = FALSE) +
#   geom_boxplot(aes(color = nash_presence),
#              outlier.shape = NA) +
#   geom_point(aes(color = nash_presence),
#     size = 2,
#     shape = 21,
#     position = position_jitterdodge()) +
#   labs(x = "",
#     y = "Prevotella copri (Abundancia relativa)") +
#   stat_compare_means(comparisons = p_value,
#                      method = "wilcox.test") +
#   theme(legend.position = "none")
# 
# ggsave("./01_tax_plots/boxplot_prevotella_copri_allsamples.svg")
# print(boxplot_prevotella_copri)
# dev.off()

#####

species.df <- phyloseq_to_df(species,
                             addtax = FALSE,
                             addtot = FALSE,
                             addmaxrank = FALSE,
                             sorting = "NULL")

write.table(species.df,
            "./00_files/species_taxonomic_profile_allsamples.tsv",
            sep = "\t")

species <- aggregate_rare(physeq,
                         level = "Species",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_species <- plot_bar(species,
                               fill = "Species") +
facet_grid(.~nash_presence,
           scales = "free_x") +
labs(x = "",
    y = "Relative abundance",
    fill = "Species") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_species_allsamples.svg")
print(barplot_tax_species)
dev.off()

```

<!-- #### LEfSe -->

```{r, echo=FALSE, warning=FALSE, include=FALSE}
# Input table
biom_otu_tax <- import_biom(biom_file)

metadata <- import_qiime_sample_data(map_file)

physeq <- merge_phyloseq(biom_otu_tax,
                         metadata)

physeq_lefse <- normalize(physeq,
                          method = "CPM")

colnames(tax_table(physeq_lefse)) <- c("Kingdom",
                                 "Phylum",
                                 "Class",
                                 "Order",
                                 "Family",
                                 "Genus",
                                 "Species")

theme_set(theme_bw())

# LEfSe Phylum
#lefse_phylum <- run_lefse(physeq_lefse,
#                          norm = "none",
#                          taxa_rank = "Phylum",
#                          group = "nash_presence")
#
#plot_lefse_phylum <- plot_ef_bar(lefse_phylum)
#
#ggsave("./01_tax_plots/metaphlan3_phylum_lefse.svg")
#print(plot_lefse_phylum)
#dev.off()

# LEfSe Class
#lefse_class <- run_lefse(physeq_lefse,
#                          norm = "none",
#                          taxa_rank = "Class",
#                          group = "nash_presence")

#plot_lefse_class <- plot_ef_bar(lefse_class)

#ggsave("./01_tax_plots/metaphlan3_class_lefse.svg")
#print(plot_lefse_class)
#dev.off()

# LEfSe Order
lefse_order <- run_lefse(physeq_lefse,
                          norm = "none",
                          taxa_rank = "Order",
                          group = "nash_presence")

plot_lefse_order <- plot_ef_bar(lefse_order)

ggsave("./01_tax_plots/metaphlan3_order_lefse.svg")
print(plot_lefse_order)
dev.off()

# LEfSe Family
lefse_family <- run_lefse(physeq_lefse,
                          norm = "none",
                          taxa_rank = "Family",
                          group = "nash_presence")

plot_lefse_family <- plot_ef_bar(lefse_family)

ggsave("./01_tax_plots/metaphlan3_family_lefse.svg")
print(plot_lefse_family)
dev.off()

# LEfSe Genera
lefse_genera <- run_lefse(physeq_lefse,
                          norm = "none",
                          taxa_rank = "Genus",
                          group = "nash_presence")

plot_lefse_genera <- plot_ef_bar(lefse_genera)

ggsave("./01_tax_plots/metaphlan3_genera_lefse.svg")
print(plot_lefse_genera)
dev.off()

# LEfSe Species
lefse_species <- run_lefse(physeq_lefse,
                          norm = "none",
                          taxa_rank = "Species",
                          group = "nash_presence")

plot_lefse_species <- plot_ef_bar(lefse_species)

ggsave("./01_tax_plots/metaphlan3_species_lefse.svg")
print(plot_lefse_species)
dev.off()

```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_phylum

#plot_lefse_phylum

```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_class

#plot_lefse_class

```


```{r, echo = FALSE, out.height = "150px"}
barplot_tax_order

plot_lefse_order
```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_family

plot_lefse_family

```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_genera

plot_lefse_genera
```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_species

plot_lefse_species
```

\newpage

### Con todas las muestras comparando "NASH" vs "non-NASH" estratificando por género (Male)

<!-- #### Barplots -->

```{r, echo=FALSE, warning=FALSE, include=FALSE}
# Input table
biom_file <- "./00_files/metaphlan3_taxonomic_profile_filt.biom"

map_file <- "./00_files/metadata_nash_presence_male.tsv"

biom_otu_tax <- import_biom(biom_file)

metadata <- import_qiime_sample_data(map_file)

physeq <- merge_phyloseq(biom_otu_tax,
                         metadata)

physeq <- normalize(physeq,
                    method = "TSS")

colnames(tax_table(physeq)) <- c("Kingdom",
                                 "Phylum",
                                 "Class",
                                 "Order",
                                 "Family",
                                 "Genus",
                                 "Species")

theme_set(theme_bw())

# Phylum level
phylum <- aggregate_rare(physeq,
                         level = "Phylum",
                         detection = 0.0001,
                         prevalence = 50/100)

barplot_tax_phylum <- plot_bar(phylum,
                               fill = "Phylum") +
facet_grid(genre~nash_presence ,
           scales = "free") +
labs(x = "",
    y = "Relative abundance",
    fill = "Phylum") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_phylum_male_gender.svg")
print(barplot_tax_phylum)
dev.off()

# Class level
class <- aggregate_rare(physeq,
                         level = "Class",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_class <- plot_bar(class,
                               fill = "Class") +
facet_grid(genre~nash_presence ,
           scales = "free") +
labs(x = "",
    y = "Relative abundance",
    fill = "Class") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_class_male_gender.svg")
print(barplot_tax_class)
dev.off()

# Order level
order <- aggregate_rare(physeq,
                         level = "Order",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_order <- plot_bar(order,
                               fill = "Order") +
facet_grid(genre~nash_presence ,
           scales = "free") +
labs(x = "",
    y = "Relative abundance",
    fill = "Order") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_order_male_gender.svg")
print(barplot_tax_order)
dev.off()

# Family level
family <- aggregate_rare(physeq,
                         level = "Family",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_family <- plot_bar(family,
                               fill = "Family") +
facet_grid(genre~nash_presence ,
           scales = "free") +
labs(x = "",
    y = "Relative abundance",
    fill = "Family") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_family_male_gender.svg")
print(barplot_tax_family)
dev.off()

# Genera level
genera <- aggregate_rare(physeq,
                         level = "Genus",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_genera <- plot_bar(genera,
                               fill = "Genus") +
facet_grid(genre~nash_presence ,
           scales = "free") +
labs(x = "",
    y = "Relative abundance",
    fill = "Genus") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_genera_male_gender.svg")
print(barplot_tax_genera)
dev.off()

# Species level
species <- aggregate_rare(physeq,
                         level = "Species",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_species <- plot_bar(species,
                               fill = "Species") +
facet_grid(genre~nash_presence ,
           scales = "free") +
labs(x = "",
    y = "Relative abundance",
    fill = "Species") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_species_male_gender.svg")
print(barplot_tax_species)
dev.off()

```

<!-- #### LEfSe -->

```{r, echo=FALSE, warning=FALSE, include=FALSE}
# Input table
biom_otu_tax <- import_biom(biom_file)

metadata <- import_qiime_sample_data(map_file)

physeq <- merge_phyloseq(biom_otu_tax,
                         metadata)

physeq_lefse <- normalize(physeq,
                          method = "CPM")

colnames(tax_table(physeq_lefse)) <- c("Kingdom",
                                 "Phylum",
                                 "Class",
                                 "Order",
                                 "Family",
                                 "Genus",
                                 "Species")

theme_set(theme_bw())

# LEfSe Phylum
#lefse_phylum <- run_lefse(physeq_lefse,
#                          norm = "none",
#                          taxa_rank = "Phylum",
#                          group = "nash_presence")
#
#plot_lefse_phylum <- plot_ef_bar(lefse_phylum)
#
#ggsave("metaphlan3_phylum_lefse_male_gender.svg")
#print(plot_lefse_phylum)
#dev.off()

# LEfSe Class
#lefse_class <- run_lefse(physeq_lefse,
#                          norm = "none",
#                          taxa_rank = "Class",
#                          group = "nash_presence")
#plot_lefse_class <- plot_ef_bar(lefse_class)
#ggsave("metaphlan3_class_lefse_male_gender.svg")
#print(plot_lefse_class)
#dev.off()

## LEfSe Order
#lefse_order <- run_lefse(physeq_lefse,
#                          norm = "none",
#                          taxa_rank = "Order",
#                          group = "nash_presence")
#
#plot_lefse_order <- plot_ef_bar(lefse_order)
#
#ggsave("metaphlan3_order_lefse_male_gender.svg")
#print(plot_lefse_order)
#dev.off()

# LEfSe Family
# lefse_family <- run_lefse(physeq_lefse,
#                          norm = "none",
#                          taxa_rank = "Family",
#                          group = "nash_presence")
# 
# plot_lefse_family <- plot_ef_bar(lefse_family)
# 
# ggsave("metaphlan3_family_lefse_male_gender.svg")
# print(plot_lefse_family)
# dev.off()

# LEfSe Genera
# lefse_genera <- run_lefse(physeq_lefse,
#                          norm = "none",
#                          taxa_rank = "Genus",
#                          group = "nash_presence")
# 
# plot_lefse_genera <- plot_ef_bar(lefse_genera)
# 
# ggsave("metaphlan3_genera_lefse_male_gender.svg")
# print(plot_lefse_genera)
# dev.off()

# LEfSe Species
lefse_species <- run_lefse(physeq_lefse,
                          norm = "none",
                          taxa_rank = "Species",
                          group = "nash_presence")

plot_lefse_species <- plot_ef_bar(lefse_species)

ggsave("./01_tax_plots/metaphlan3_species_lefse_male_gender.svg")
print(plot_lefse_species)
dev.off()

```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_phylum

#plot_lefse_phylum

```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_class

#plot_lefse_class

```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_order

#plot_lefse_order

```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_family

# plot_lefse_family

```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_genera

# plot_lefse_genera
```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_species

plot_lefse_species
```

\newpage

### Con todas las muestras comparando "NASH" vs "non-NASH" estratificando por género (Female)

<!-- #### Barplots -->

```{r, echo=FALSE, warning=FALSE, include=FALSE}
# Input table
biom_file <- "./00_files/metaphlan3_taxonomic_profile_filt.biom"

map_file <- "./00_files/metadata_nash_presence_female.tsv"

biom_otu_tax <- import_biom(biom_file)

metadata <- import_qiime_sample_data(map_file)

physeq <- merge_phyloseq(biom_otu_tax,
                         metadata)

physeq <- normalize(physeq,
                    method = "TSS")

colnames(tax_table(physeq)) <- c("Kingdom",
                                 "Phylum",
                                 "Class",
                                 "Order",
                                 "Family",
                                 "Genus",
                                 "Species")

theme_set(theme_bw())

# Phylum level
phylum <- aggregate_rare(physeq,
                         level = "Phylum",
                         detection = 0.0001,
                         prevalence = 50/100)

barplot_tax_phylum <- plot_bar(phylum,
                               fill = "Phylum") +
facet_grid(genre~nash_presence ,
           scales = "free") +
labs(x = "",
    y = "Relative abundance",
    fill = "Phylum") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_phylum_female_gender.svg")
print(barplot_tax_phylum)
dev.off()

# Class level
class <- aggregate_rare(physeq,
                         level = "Class",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_class <- plot_bar(class,
                               fill = "Class") +
facet_grid(genre~nash_presence ,
           scales = "free") +
labs(x = "",
    y = "Relative abundance",
    fill = "Class") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_class_female_gender.svg")
print(barplot_tax_class)
dev.off()

# Order level
order <- aggregate_rare(physeq,
                         level = "Order",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_order <- plot_bar(order,
                               fill = "Order") +
facet_grid(genre~nash_presence ,
           scales = "free") +
labs(x = "",
    y = "Relative abundance",
    fill = "Order") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_order_female_gender.svg")
print(barplot_tax_order)
dev.off()

# Family level
family <- aggregate_rare(physeq,
                         level = "Family",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_family <- plot_bar(family,
                               fill = "Family") +
facet_grid(genre~nash_presence ,
           scales = "free") +
labs(x = "",
    y = "Relative abundance",
    fill = "Family") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_family_female_gender.svg")
print(barplot_tax_family)
dev.off()

# Genera level
genera <- aggregate_rare(physeq,
                         level = "Genus",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_genera <- plot_bar(genera,
                               fill = "Genus") +
facet_grid(genre~nash_presence ,
           scales = "free") +
labs(x = "",
    y = "Relative abundance",
    fill = "Genus") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_genera_female_gender.svg")
print(barplot_tax_genera)
dev.off()

# Species level
species <- aggregate_rare(physeq,
                         level = "Species",
                         detection = 0.01,
                         prevalence = 50/100)

barplot_tax_species <- plot_bar(species,
                               fill = "Species") +
facet_grid(genre~nash_presence ,
           scales = "free") +
labs(x = "",
    y = "Relative abundance",
    fill = "Species") +
scale_x_discrete(expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

ggsave("./01_tax_plots/metaphlan3_species_female_gender.svg")
print(barplot_tax_species)
dev.off()

```

<!-- #### LEfSe -->

```{r, echo=FALSE, warning=FALSE, include=FALSE}
# Input table
biom_otu_tax <- import_biom(biom_file)

metadata <- import_qiime_sample_data(map_file)

physeq <- merge_phyloseq(biom_otu_tax,
                         metadata)

physeq_lefse <- normalize(physeq,
                          method = "CPM")

colnames(tax_table(physeq_lefse)) <- c("Kingdom",
                                 "Phylum",
                                 "Class",
                                 "Order",
                                 "Family",
                                 "Genus",
                                 "Species")

theme_set(theme_bw())

# LEfSe Phylum
# lefse_phylum <- run_lefse(physeq_lefse,
#                          norm = "none",
#                          taxa_rank = "Phylum",
#                          group = "nash_presence")
# 
# plot_lefse_phylum <- plot_ef_bar(lefse_phylum)
# 
# ggsave("./01_tax_plots/metaphlan3_phylum_lefse_female_gender.svg")
# print(plot_lefse_phylum)
# dev.off()

# LEfSe Class
# lefse_class <- run_lefse(physeq_lefse,
#                          norm = "none",
#                          taxa_rank = "Class",
#                          group = "nash_presence")
# plot_lefse_class <- plot_ef_bar(lefse_class)
# ggsave("./01_tax_plots/metaphlan3_class_lefse_female_gender.svg")
# print(plot_lefse_class)
# dev.off()

## LEfSe Order
lefse_order <- run_lefse(physeq_lefse,
                          norm = "none",
                          taxa_rank = "Order",
                          group = "nash_presence")

plot_lefse_order <- plot_ef_bar(lefse_order)

ggsave("./01_tax_plots/metaphlan3_order_lefse_female_gender.svg")
print(plot_lefse_order)
dev.off()

# LEfSe Family
lefse_family <- run_lefse(physeq_lefse,
                          norm = "none",
                          taxa_rank = "Family",
                          group = "nash_presence")

plot_lefse_family <- plot_ef_bar(lefse_family)

ggsave("./01_tax_plots/metaphlan3_family_lefse_female_gender.svg")
print(plot_lefse_family)
dev.off()

# LEfSe Genera
lefse_genera <- run_lefse(physeq_lefse,
                          norm = "none",
                          taxa_rank = "Genus",
                          group = "nash_presence")

plot_lefse_genera <- plot_ef_bar(lefse_genera)

ggsave("./01_tax_plots/metaphlan3_genera_lefse_female_gender.svg")
print(plot_lefse_genera)
dev.off()

# LEfSe Species
lefse_species <- run_lefse(physeq_lefse,
                          norm = "none",
                          taxa_rank = "Species",
                          group = "nash_presence")

plot_lefse_species <- plot_ef_bar(lefse_species)

ggsave("./01_tax_plots/metaphlan3_species_lefse_female_gender.svg")
print(plot_lefse_species)
dev.off()

```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_phylum

# plot_lefse_phylum

```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_class

# plot_lefse_class

```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_order

plot_lefse_order

```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_family

plot_lefse_family

```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_genera

plot_lefse_genera
```

```{r, echo = FALSE, out.height = "150px"}
barplot_tax_species

plot_lefse_species
```

\newpage

## MetaPhlAn3, diversidad alfa

### Con todas las muestras comparando "NASH" vs "non-NASH"

```{r, echo=FALSE, warning=FALSE, include=FALSE}
# Input table
biom_file <- "./00_files/metaphlan3_taxonomic_profile_filt.biom"

map_file <- "./00_files/metadata_nash_presence.tsv"

biom_otu_tax <- import_biom(biom_file)

metadata <- import_qiime_sample_data(map_file)

physeq <- merge_phyloseq(biom_otu_tax,
                         metadata)

rarefied = rarefy_even_depth(physeq,
                             rngseed=1,
                             sample.size=min(sample_sums(physeq)))

theme_set(theme_bw())

# Observed species
alpha_observed <- plot_richness(rarefied,
                                measures = c("Observed"),
                                color = "nash_presence") +
labs(x = "",
    y = "Observed species") +
facet_grid(.~nash_presence,
           scales = "free_x") +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

# alpha_observed_curve <- rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)

ggsave("./02_adiv_plots/alpha_observed_nash_presence.svg")
print(alpha_observed)
# print(rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5))
dev.off()

# svg(filename="./02_adiv_plots/alpha_observed_curve_nash_presence.svg")
# rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)
# dev.off()

# Chao1
alpha_chao1 <- plot_richness(rarefied,
                             measures = c("Chao1"),
                             color = "nash_presence") +
labs(x = "",
    y = "Chao1 Index") +
facet_grid(.~nash_presence,
           scales = "free_x") +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

# alpha_chao1_curve <- rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)

ggsave("./02_adiv_plots/alpha_chao1_nash_presence.svg")
print(alpha_chao1)
# print(rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5))
dev.off()

# svg(filename="./02_adiv_plots/alpha_chao1_curve_nash_presence.svg")
# rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)
# dev.off()

# Shannon
alpha_shannon <- plot_richness(rarefied,
                               measures = c("Shannon"),
                               color = "nash_presence") +
labs(x = "",
    y = "Shannon Index") +
facet_grid(.~nash_presence,
           scales = "free_x") +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

# alpha_shannon_curve <- rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)

ggsave("./02_adiv_plots/alpha_shannon_nash_presence.svg")
print(alpha_shannon)
# print(rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5))
dev.off()

# svg(filename="./02_adiv_plots/alpha_shannon_curve_nash_presence.svg")
# rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)
# dev.off()

# All metrics

p_value <- list(c("NASH",
                  "non-NASH"))

alpha <- plot_richness(rarefied,
              measures = c("Observed",
                           "Chao1",
                           "Shannon"),
              x = "nash_presence",
              color = "nash_presence") +
  geom_boxplot() +
  labs(x = "",
       fill = "") +
  theme(legend.position='none',
        axis.text.x = element_text(size = 7,
                                   angle = 360,
                                   hjust = 0.5)) +
  stat_compare_means(comparisons = p_value,
                     method = "wilcox.test")

alpha

ggsave("./02_adiv_plots/alpha_nash_presence.svg")
print(alpha)
# print(rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5))
dev.off()

```

```{r, echo = FALSE, warning=FALSE}
# alpha_observed
# 
# alpha_chao1
# 
# alpha_shannon

alpha
```

\newpage

### Con todas las muestras comparando "NASH" vs "non-NASH" estratificando por género (Male)

```{r, echo=FALSE, warning=FALSE, include=FALSE}
# Input table
biom_file <- "./00_files/metaphlan3_taxonomic_profile_filt.biom"

map_file <- "./00_files/metadata_nash_presence_male.tsv"

biom_otu_tax <- import_biom(biom_file)

metadata <- import_qiime_sample_data(map_file)

physeq <- merge_phyloseq(biom_otu_tax,
                         metadata)

rarefied = rarefy_even_depth(physeq,
                             rngseed=1,
                             sample.size=min(sample_sums(physeq)))

theme_set(theme_bw())

# Observed species
alpha_observed <- plot_richness(rarefied,
                                measures = c("Observed"),
                                color = "nash_presence") +
labs(x = "",
    y = "Observed species") +
facet_grid(.~nash_presence,
           scales = "free_x") +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

# alpha_observed_curve <- rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)

ggsave("./02_adiv_plots/alpha_observed_nash_presence_male.svg")
print(alpha_observed)
# print(rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5))
dev.off()

# svg(filename="./02_adiv_plots/alpha_observed_curve_nash_presence_male.svg")
# rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)
# dev.off()

# Chao1
alpha_chao1 <- plot_richness(rarefied,
                             measures = c("Chao1"),
                             color = "nash_presence") +
labs(x = "",
    y = "Chao1 Index") +
facet_grid(.~nash_presence,
           scales = "free_x") +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

# alpha_chao1_curve <- rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)

ggsave("./02_adiv_plots/alpha_chao1_nash_presence_male.svg")
print(alpha_chao1)
# print(rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5))
dev.off()

# svg(filename="./02_adiv_plots/alpha_chao1_curve_nash_presence_male.svg")
# rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)
# dev.off()

# Shannon
alpha_shannon <- plot_richness(rarefied,
                               measures = c("Shannon"),
                               color = "nash_presence") +
labs(x = "",
    y = "Shannon Index") +
facet_grid(.~nash_presence,
           scales = "free_x") +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

# alpha_shannon_curve <- rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)

ggsave("./02_adiv_plots/alpha_shannon_nash_presence_male.svg")
print(alpha_shannon)
# print(rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5))
dev.off()

# svg(filename="./02_adiv_plots/alpha_shannon_curve_nash_presence_male.svg")
# rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)
# dev.off()

# All metrics

p_value <- list(c("NASH",
                  "non-NASH"))

alpha <- plot_richness(rarefied,
              measures = c("Observed",
                           "Chao1",
                           "Shannon"),
              x = "nash_presence",
              color = "nash_presence") +
  geom_boxplot() +
  labs(x = "",
       fill = "") +
  theme(legend.position='none',
        axis.text.x = element_text(size = 7,
                                   angle = 360,
                                   hjust = 0.5)) +
  stat_compare_means(comparisons = p_value,
                     method = "wilcox.test")

alpha

ggsave("./02_adiv_plots/alpha_nash_presence_male.svg")
print(alpha)
# print(rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5))
dev.off()

```

```{r, echo = FALSE, warning=FALSE}
# alpha_observed
# 
# alpha_chao1
# 
# alpha_shannon

alpha
```

\newpage

### Con todas las muestras comparando "NASH" vs "non-NASH" estratificando por género (Female)

```{r, echo=FALSE, warning=FALSE, include=FALSE}
# Input table
biom_file <- "./00_files/metaphlan3_taxonomic_profile_filt.biom"

map_file <- "./00_files/metadata_nash_presence_female.tsv"

biom_otu_tax <- import_biom(biom_file)

metadata <- import_qiime_sample_data(map_file)

physeq <- merge_phyloseq(biom_otu_tax,
                         metadata)

rarefied = rarefy_even_depth(physeq,
                             rngseed=1,
                             sample.size=min(sample_sums(physeq)))

theme_set(theme_bw())

# Observed species
alpha_observed <- plot_richness(rarefied,
                                measures = c("Observed"),
                                color = "nash_presence") +
labs(x = "",
    y = "Observed species") +
facet_grid(.~nash_presence,
           scales = "free_x") +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

# alpha_observed_curve <- rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)

ggsave("./02_adiv_plots/alpha_observed_nash_presence_female.svg")
print(alpha_observed)
# print(rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5))
dev.off()

# svg(filename="./02_adiv_plots/alpha_observed_curve_nash_presence_female.svg")
# rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)
# dev.off()

# Chao1
alpha_chao1 <- plot_richness(rarefied,
                             measures = c("Chao1"),
                             color = "nash_presence") +
labs(x = "",
    y = "Chao1 Index") +
facet_grid(.~nash_presence,
           scales = "free_x") +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

# alpha_chao1_curve <- rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)

ggsave("./02_adiv_plots/alpha_chao1_nash_presence_female.svg")
print(alpha_chao1)
# print(rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5))
dev.off()

# svg(filename="./02_adiv_plots/alpha_chao1_curve_nash_presence_female.svg")
# rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)
# dev.off()

# Shannon
alpha_shannon <- plot_richness(rarefied,
                               measures = c("Shannon"),
                               color = "nash_presence") +
labs(x = "",
    y = "Shannon Index") +
facet_grid(.~nash_presence,
           scales = "free_x") +
theme(axis.text.x = element_text(size = 7,
                                 angle = 90,
                                 vjust = 0.5))

# alpha_shannon_curve <- rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)

ggsave("./02_adiv_plots/alpha_shannon_nash_presence_female.svg")
print(alpha_shannon)
# print(rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5))
dev.off()

# svg(filename="./02_adiv_plots/alpha_shannon_curve_nash_presence_female.svg")
# rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5)
# dev.off()

# All metrics

p_value <- list(c("NASH",
                  "non-NASH"))

alpha <- plot_richness(rarefied,
              measures = c("Observed",
                           "Chao1",
                           "Shannon"),
              x = "nash_presence",
              color = "nash_presence") +
  geom_boxplot() +
  labs(x = "",
       fill = "") +
  theme(legend.position='none',
        axis.text.x = element_text(size = 7,
                                   angle = 360,
                                   hjust = 0.5)) +
  stat_compare_means(comparisons = p_value,
                     method = "wilcox.test")

alpha

ggsave("./02_adiv_plots/alpha_nash_presence_female.svg")
print(alpha)
# print(rarecurve(t(otu_table(rarefied)),
#                                  step=50,
#                                  cex = 0.5))
dev.off()

```

```{r, echo = FALSE, warning=FALSE}
# alpha_observed
# 
# alpha_chao1
# 
# alpha_shannon

alpha
```

\newpage

## MetaPhlAn3, diversidad beta

### Con todas las muestras comparando "NASH" vs "non-NASH"

```{r, echo=FALSE, warning=FALSE, include=FALSE}
# Input table
biom_file <- "./00_files/metaphlan3_taxonomic_profile_filt.biom"

map_file <- "./00_files/metadata_nash_presence.tsv"

biom_otu_tax <- import_biom(biom_file)

metadata <- import_qiime_sample_data(map_file)

physeq <- merge_phyloseq(biom_otu_tax,
                         metadata)

rarefied = rarefy_even_depth(physeq,
                             rngseed=1,
                             sample.size=min(sample_sums(physeq)))

theme_set(theme_bw())

# Bray-Curtis PCoA
braycurtis_dist = phyloseq::distance(rarefied,
                                     method="bray")

ordination = ordinate(rarefied,
                      method="PCoA",
                      distance="bray")

# 1 vs 2
beta_braycurtis_1vs2 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 1:2,
                label = "sample") +
  labs(title = "Beta diversity, Bray-Curtis") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_braycurtis_1vs2_nash_presence.svg")
  print(beta_braycurtis_1vs2)
dev.off()

# 1 vs 3
beta_braycurtis_1vs3 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 1-3,
                label = "sample") +
  labs(title = "Beta diversity, Bray-Curtis") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_braycurtis_1vs3_nash_presence.svg")
  print(beta_braycurtis_1vs3)
dev.off()

# 2 vs 3
beta_braycurtis_2vs3 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 2-3,
                label = "sample") +
  labs(title = "Beta diversity, Bray-Curtis") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_braycurtis_2vs3_nash_presence.svg")
  print(beta_braycurtis_2vs3)
dev.off()

# Jaccard PCoA
jaccard_dist = phyloseq::distance(rarefied,
                                  method="jaccard")

ordination = ordinate(rarefied,
                      method="PCoA",
                      distance="jaccard")

# 1 vs 2
beta_jaccard_1vs2 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 1:2,
                label = "sample") +
  labs(title = "Beta diversity, Jaccard") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_jaccard_1vs2_nash_presence.svg")
  print(beta_jaccard_1vs2)
dev.off()

# 1 vs 3
beta_jaccard_1vs3 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 1-3,
                label = "sample") +
  labs(title = "Beta diversity, Jaccard") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_jaccard_1vs3_nash_presence.svg")
  print(beta_jaccard_1vs3)
dev.off()

# 2 vs 3
beta_jaccard_2vs3 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 2-3,
                label = "sample") +
  labs(title = "Beta diversity, Jaccard") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_jaccard_2vs3_nash_presence.svg")
  print(beta_jaccard_2vs3)
dev.off()

```

```{r, echo = FALSE, out.width = "175px"}
beta_braycurtis_1vs2

beta_braycurtis_1vs3

beta_braycurtis_2vs3
```

```{r, echo = FALSE, out.width = "175px"}
beta_jaccard_1vs2
beta_jaccard_1vs3
beta_jaccard_2vs3
```

\newpage

### Con todas las muestras comparando "NASH" vs "non-NASH" contrastando géneros

```{r, echo=FALSE, warning=FALSE, include=FALSE}
# Input table
biom_file <- "./00_files/metaphlan3_taxonomic_profile_filt.biom"

map_file <- "./00_files/metadata_nash_presence.tsv"

biom_otu_tax <- import_biom(biom_file)

metadata <- import_qiime_sample_data(map_file)

physeq <- merge_phyloseq(biom_otu_tax,
                         metadata)

rarefied = rarefy_even_depth(physeq,
                             rngseed=1,
                             sample.size=min(sample_sums(physeq)))

theme_set(theme_bw())

# Bray-Curtis PCoA
braycurtis_dist = phyloseq::distance(rarefied,
                                     method="bray")

ordination = ordinate(rarefied,
                      method="PCoA",
                      distance="bray")

# 1 vs 2
beta_braycurtis_1vs2 <- plot_ordination(rarefied,
                ordination,
                color = "genre",
                axes = 1:2,
                label = "sample") +
  labs(title = "Beta diversity, Bray-Curtis") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_braycurtis_1vs2_nash_presence_gender.svg")
  print(beta_braycurtis_1vs2)
dev.off()

# 1 vs 3
beta_braycurtis_1vs3 <- plot_ordination(rarefied,
                ordination,
                color = "genre",
                axes = 1-3,
                label = "sample") +
  labs(title = "Beta diversity, Bray-Curtis") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_braycurtis_1vs3_nash_presence_gender.svg")
  print(beta_braycurtis_1vs3)
dev.off()

# 2 vs 3
beta_braycurtis_2vs3 <- plot_ordination(rarefied,
                ordination,
                color = "genre",
                axes = 2-3,
                label = "sample") +
  labs(title = "Beta diversity, Bray-Curtis") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_braycurtis_2vs3_nash_presence_gender.svg")
  print(beta_braycurtis_2vs3)
dev.off()

# Jaccard PCoA
jaccard_dist = phyloseq::distance(rarefied,
                                  method="jaccard")

ordination = ordinate(rarefied,
                      method="PCoA",
                      distance="jaccard")

# 1 vs 2
beta_jaccard_1vs2 <- plot_ordination(rarefied,
                ordination,
                color = "genre",
                axes = 1:2,
                label = "sample") +
  labs(title = "Beta diversity, Jaccard") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_jaccard_1vs2_nash_presence_gender.svg")
  print(beta_jaccard_1vs2)
dev.off()

# 1 vs 3
beta_jaccard_1vs3 <- plot_ordination(rarefied,
                ordination,
                color = "genre",
                axes = 1-3,
                label = "sample") +
  labs(title = "Beta diversity, Jaccard") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_jaccard_1vs3_nash_presence_gender.svg")
  print(beta_jaccard_1vs3)
dev.off()

# 2 vs 3
beta_jaccard_2vs3 <- plot_ordination(rarefied,
                ordination,
                color = "genre",
                axes = 2-3,
                label = "sample") +
  labs(title = "Beta diversity, Jaccard") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_jaccard_2vs3_nash_presence_gender.svg")
  print(beta_jaccard_2vs3)
dev.off()

```

```{r, echo = FALSE, out.width = "175px"}
beta_braycurtis_1vs2
beta_braycurtis_1vs3
beta_braycurtis_2vs3
```

```{r, echo = FALSE, out.width = "175px"}
beta_jaccard_1vs2
beta_jaccard_1vs3
beta_jaccard_2vs3
```

\newpage

### Con todas las muestras comparando "NASH" vs "non-NASH" estratificando por género (Male)

```{r, echo=FALSE, warning=FALSE, include=FALSE}
# Input table
biom_file <- "./00_files/metaphlan3_taxonomic_profile_filt.biom"

map_file <- "./00_files/metadata_nash_presence_male.tsv"

biom_otu_tax <- import_biom(biom_file)

metadata <- import_qiime_sample_data(map_file)

physeq <- merge_phyloseq(biom_otu_tax,
                         metadata)

rarefied = rarefy_even_depth(physeq,
                             rngseed=1,
                             sample.size=min(sample_sums(physeq)))

theme_set(theme_bw())

# Bray-Curtis PCoA
braycurtis_dist = phyloseq::distance(rarefied,
                                     method="bray")

ordination = ordinate(rarefied,
                      method="PCoA",
                      distance="bray")

# 1 vs 2
beta_braycurtis_1vs2 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 1:2,
                label = "sample") +
  labs(title = "Beta diversity, Bray-Curtis") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_braycurtis_1vs2_nash_presence_male.svg")
  print(beta_braycurtis_1vs2)
dev.off()

# 1 vs 3
beta_braycurtis_1vs3 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 1-3,
                label = "sample") +
  labs(title = "Beta diversity, Bray-Curtis") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_braycurtis_1vs3_nash_presence_male.svg")
  print(beta_braycurtis_1vs3)
dev.off()

# 2 vs 3
beta_braycurtis_2vs3 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 2-3,
                label = "sample") +
  labs(title = "Beta diversity, Bray-Curtis") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_braycurtis_2vs3_nash_presence_male.svg")
  print(beta_braycurtis_2vs3)
dev.off()

# Jaccard PCoA
jaccard_dist = phyloseq::distance(rarefied,
                                  method="jaccard")

ordination = ordinate(rarefied,
                      method="PCoA",
                      distance="jaccard")

# 1 vs 2
beta_jaccard_1vs2 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 1:2,
                label = "sample") +
  labs(title = "Beta diversity, Jaccard") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_jaccard_1vs2_nash_presence_male.svg")
  print(beta_jaccard_1vs2)
dev.off()

# 1 vs 3
beta_jaccard_1vs3 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 1-3,
                label = "sample") +
  labs(title = "Beta diversity, Jaccard") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_jaccard_1vs3_nash_presence_male.svg")
  print(beta_jaccard_1vs3)
dev.off()

# 2 vs 3
beta_jaccard_2vs3 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 2-3,
                label = "sample") +
  labs(title = "Beta diversity, Jaccard") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_jaccard_2vs3_nash_presence_male.svg")
  print(beta_jaccard_2vs3)
dev.off()

```

```{r, echo = FALSE, out.width = "175px"}
beta_braycurtis_1vs2
beta_braycurtis_1vs3
beta_braycurtis_2vs3
```

```{r, echo = FALSE, out.width = "175px"}
beta_jaccard_1vs2
beta_jaccard_1vs3
beta_jaccard_2vs3
```

\newpage

### Con todas las muestras comparando "NASH" vs "non-NASH" estratificando por género (Female)

```{r, echo=FALSE, warning=FALSE, include=FALSE}
# Input table
biom_file <- "./00_files/metaphlan3_taxonomic_profile_filt.biom"

map_file <- "./00_files/metadata_nash_presence_female.tsv"

biom_otu_tax <- import_biom(biom_file)

metadata <- import_qiime_sample_data(map_file)

physeq <- merge_phyloseq(biom_otu_tax,
                         metadata)

rarefied = rarefy_even_depth(physeq,
                             rngseed=1,
                             sample.size=min(sample_sums(physeq)))

theme_set(theme_bw())

# Bray-Curtis PCoA
braycurtis_dist = phyloseq::distance(rarefied,
                                     method="bray")

ordination = ordinate(rarefied,
                      method="PCoA",
                      distance="bray")

# 1 vs 2
beta_braycurtis_1vs2 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 1:2,
                label = "sample") +
  labs(title = "Beta diversity, Bray-Curtis") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_braycurtis_1vs2_nash_presence_female.svg")
  print(beta_braycurtis_1vs2)
dev.off()

# 1 vs 3
beta_braycurtis_1vs3 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 1-3,
                label = "sample") +
  labs(title = "Beta diversity, Bray-Curtis") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_braycurtis_1vs3_nash_presence_female.svg")
  print(beta_braycurtis_1vs3)
dev.off()

# 2 vs 3
beta_braycurtis_2vs3 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 2-3,
                label = "sample") +
  labs(title = "Beta diversity, Bray-Curtis") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_braycurtis_2vs3_nash_presence_female.svg")
  print(beta_braycurtis_2vs3)
dev.off()

# Jaccard PCoA
jaccard_dist = phyloseq::distance(rarefied,
                                  method="jaccard")

ordination = ordinate(rarefied,
                      method="PCoA",
                      distance="jaccard")

# 1 vs 2
beta_jaccard_1vs2 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 1:2,
                label = "sample") +
  labs(title = "Beta diversity, Jaccard") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_jaccard_1vs2_nash_presence_female.svg")
  print(beta_jaccard_1vs2)
dev.off()

# 1 vs 3
beta_jaccard_1vs3 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 1-3,
                label = "sample") +
  labs(title = "Beta diversity, Jaccard") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_jaccard_1vs3_nash_presence_female.svg")
  print(beta_jaccard_1vs3)
dev.off()

# 2 vs 3
beta_jaccard_2vs3 <- plot_ordination(rarefied,
                ordination,
                color = "nash_presence",
                axes = 2-3,
                label = "sample") +
  labs(title = "Beta diversity, Jaccard") +
  theme(aspect.ratio=1)

ggsave("./03_bdiv_plots/beta_jaccard_2vs3_nash_presence_female.svg")
  print(beta_jaccard_2vs3)
dev.off()

```

```{r, echo = FALSE, out.width = "175px"}
beta_braycurtis_1vs2
beta_braycurtis_1vs3
beta_braycurtis_2vs3
```

```{r, echo = FALSE, out.width = "175px"}
beta_jaccard_1vs2
beta_jaccard_1vs3
beta_jaccard_2vs3
```

\newpage